groups:
- name: nginx-ingress-alerts
  rules:
  # 1. Задержка (Latency)
  - alert: HighLatency
    expr: histogram_quantile(0.95, sum(rate(nginx_ingress_controller_request_duration_seconds_bucket[5m])) by (le)) > 0.5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Высокая задержка запросов NGINX Ingress"
      description: "95-й процентиль задержки запросов превышает установленный порог в течение 5 минут."

  # 2. Ошибки (Errors)
  - alert: HighErrorRate
    expr: sum(rate(nginx_ingress_controller_requests{status=~"5.."}[5m])) by (ingress) / sum(rate(nginx_ingress_controller_requests[5m])) by (ingress) > 0.05
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Высокий процент ошибок NGINX Ingress"
      description: "Процент запросов, завершившихся ошибкой (5xx), превышает 5% в течение 5 минут."

  # 3. Трафик (Traffic)
  - alert: HighTraffic
    expr: sum(rate(nginx_ingress_controller_requests[1m])) by (ingress) > 1000
    for: 5m
    labels:
      severity: info
    annotations:
      summary: "Высокий уровень трафика через NGINX Ingress"
      description: "Число запросов через Ingress превышает 1000 в минуту в течение 5 минут."

  # 4. Насыщенность системы (Saturation)
  - alert: HighCpuUsage
    expr: sum(rate(nginx_ingress_controller_nginx_process_cpu_seconds_total[1m])) by (pod) > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Высокая загрузка CPU на NGINX Ingress"
      description: "Использование CPU выше 80% в течение 5 минут."
